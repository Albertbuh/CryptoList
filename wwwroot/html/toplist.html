<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Toplist</title>
    <link rel="stylesheet" href="../styles/toplist.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caprasimo&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caprasimo&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <h1>Toplist</h1>
    <div class="background"></div>
    <div class="toplist" id="table-container"></div>
    <script>
      function isMobile() {
        const regex =
          /Mobi|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i;
        return regex.test(navigator.userAgent);
      }
      function setGetUrl() {
        let url = "";
        if (isMobile()) url = "/crypt/mobile";
        else url = "/crypt";
        console.log(url);
        return url;
      }      

      async function GetToplist(url) {
        const response = await fetch(url, {
          method: "GET",
          headers: { Accept: "application/json" },
        });
        if (response.ok) {
          const toplist = await response.json();
          if(url !== "/crypt/mobile")
            createTable(toplist.result);
          else
            createMobileTable(toplist.result);
        }
      }

      function createMobileTable(collection)
      {
        let table = document.createElement("table");
        let header = "<tr><th>Name</th><th>FullName</th><th>Price</th><th>&percnt;Chg</th></tr>";
        table.insertAdjacentHTML("afterbegin", header);
        let tbody = document.createElement("tbody");
        collection.forEach((item) => {
          createMobileRow(tbody, item);
        });
        table.append(tbody);
        document.getElementById("table-container").append(table);
      }

      function createMobileRow(parent, crypt) {
        const tr = document.createElement("tr");
        createEssenseRows(tr, crypt);
        tr.append(createTd(crypt.change.toFixed(2)));
        parent.append(tr);
      }

      function createTable(collection) {
        let table = document.createElement("table");
        let header = "<tr><th>Name</th><th>FullName</th><th>Price</th><th>Direct Vol</th><th>Total Vol</th><th>Top Tier Vol</th><th>Market Cap</th><th>&percnt;Chg</th></tr>";
        table.insertAdjacentHTML("afterbegin", header);
        let tbody = document.createElement("tbody");
        collection.forEach((item) => {
          createRow(tbody, item);
        });
        table.append(tbody);
        document.getElementById("table-container").append(table);
      }

      function createRow(parent, crypt) {
        const tr = document.createElement("tr");
        createEssenseRows(tr, crypt);
        createVolumeRows(tr, crypt);
        createMarketRows(tr, crypt);
        parent.append(tr);
      }

      function createEssenseRows(tr, crypt) {
        tr.append(createTd(`${crypt.id}`));
        tr.append(createTd(`${crypt.name}`));
        if(crypt.price > 0.0001) tr.append(createTd(`&dollar; ${crypt.price.toFixed(4)}`));
        else tr.append(createTd(`&dollar; ${crypt.price}`));

      }
      function createVolumeRows(tr, crypt) {
        tr.append(createTd(`&dollar; ${highDigitToString(crypt.direct)}`, "volume"));
        tr.append(createTd(`&dollar; ${highDigitToString(crypt.total)}`, "volume"));
        tr.append(createTd(`&dollar; ${highDigitToString(crypt.topTier)}`, "volume"));
      }
      function createMarketRows(tr, crypt) {
        tr.append(createTd(`&dollar; ${highDigitToString(crypt.marketCap)}`, "market"));
        tr.append(createTd(`${crypt.change.toFixed(2)} &percnt;`));
      }

      function createTd(data, className = "") {
        let td = document.createElement("td");
        if(className)
          td.classList.add(className);
        td.innerHTML = data;
        return td;
      }

      function highDigitToString(num) {
        const thousand = 1000;
        const million = thousand * 1000;
        const billion = million * 1000;
        let size = "";
        if (num > billion) {
          num /= billion;
          size = "B";
        } else if (num > million) {
          num /= million;
          size = "M";
        } else if (num > thousand) {
          num /= thousand;
          size = "K";
        }
        return `${num.toFixed(2)} ${size}`;
      }

      function clearOldTable() {
        document.querySelector("table").remove();
      }
      GetToplist(setGetUrl());

      setTimeout(async function resetToplist() {
        await GetToplist(setGetUrl());
        clearOldTable();
        setTimeout(resetToplist, 5000);
      }, 5000);
    </script>
  </body>
</html>
