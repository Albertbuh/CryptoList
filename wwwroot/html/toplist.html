<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Toplist</title>
    <link rel="stylesheet" href="../styles/toplist.css" />
    <link rel="stylesheet" href="../styles/coin.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Caprasimo&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Caprasimo&family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <h1>Toplist</h1>
    <div class="background"></div>
    <div class="toplist" id="table-container">
      <table></table>
    </div>
    <script src="../js/Elements/volumeElement.js"></script>
    <script src="../js/Elements/coinElement.js"></script>
    <script src="../js/createTable.js"></script>
    <script src="../js/mobileCheck.js"></script>
    <script>
      async function GetToplist(url) {
        const response = await fetch(url, {
          method: "GET",
          headers: { Accept: "application/json" },
        });
        if (response.ok) {
          const toplist = await response.json();
          return toplist;
        }
      }

      function ToFixed(value) {
        if (value - 1 > 0.000000001) return value.toFixed(2);

        let f = 2;
        while (value < 1) {
          value *= 10;
          f++;
        }
        return value.toFixed(f);
      }

      function insert(elem, value, position = "beforeend") {
        elem.innerHTML = "";
        elem.insertAdjacentHTML(position, value);
        return elem;
      }

      function createChangeElement(chg) {
        let span = document.createElement("span");
        span.classList.add("change");
        if (chg < 0) span.classList.add("lower-color");
        else if (chg > 0) span.classList.add("higher-color");
        span.insertAdjacentHTML("beforeend", `&percnt; ${chg.toFixed(2)}`);
        return span;
      }

      function createPriceElement(price) {
        let span = document.createElement("span");
        span.classList.add("price");

        span.insertAdjacentHTML("beforeend", `&dollar; ${ToFixed(price)}`);
        return span;
      }

      function checkTable(collection) {
        let rows = document.querySelector("tbody").rows;
        let rowsLength = rows.length;
        let rowIndex = 0;
        collection.forEach((item) => {
          checkPriceCell(rows[rowIndex], item.price);

          rowIndex++;
        });
      }

      function checkPriceCell(row, price) {
        let priceTd = row.querySelector(".price");
        let oldPrice = priceTd.textContent.match(/[+-]?\d+(\.\d+)?/g)[0];
        let newPrice = ToFixed(price);
        let isEqual = checkValue(oldPrice, newPrice);
        if (isEqual != 0) {
          if (isEqual < 0) {
            priceTd.classList.add("lower-color");
          } else if (isEqual > 0) {
            priceTd.classList.add("higher-color");
          }
          setTimeout(() => {
            priceTd.classList.remove("higher-color", "lower-color");
          }, 1500);
          priceTd = insert(priceTd, `&dollar; ${newPrice}`);
        }
      }

      function checkValue(oldPrice, newPrice) {
        let delta = newPrice - oldPrice;
        let result;
        if (Math.abs(delta) < 0.01)
          //item.price === price
          result = 0;
        else if (delta < 0) {
          //item.price < price
          result = -1;
        } else if (delta > 0) {
          //item.price > price
          result = 1;
        }
        return result;
      }

      async function start() {
        createTableHeader(
          "Coin",
          "Price",
          "Direct Vol",
          "Total Vol",
          "Top Tier Vol",
          "Market Cap",
          "&percnt;  Chg"
        );
        let toplist = await GetToplist(setGetUrl());
        createTableBody(toplist);

        setTimeout(async function resetToplist() {
          let result = await GetToplist(setGetUrl());
          // document.querySelector("tbody").remove();
          // createTableBody(result);
          checkTable(result);
          setTimeout(resetToplist, 3500);
        }, 3500);
        // setInterval(async () => {
        //   let result = await GetToplist(setGetUrl());
        //   checkTable(result);
        // }, 3500);
      }

      start();
    </script>
  </body>
</html>
