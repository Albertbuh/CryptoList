<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Toplist</title>
    <link rel="stylesheet" href="../styles/toplist/toplist.css" />
    <link rel="stylesheet" href="../styles/toplist/coin.css" />
    <link rel="stylesheet" href="../styles/general.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Caprasimo&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Caprasimo&family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <h1>Toplist</h1>
    <div class="background"></div>
    <div class="toplist">
      <table></table>
    </div>
    <script src="../js/location.js"></script>
    <script src="../js/cookie.js"></script>
    <script src="../js/toFixed.js"></script>
    <script src="../js/toplist/Elements/volumeElement.js"></script>
    <script src="../js/toplist/Elements/coinElement.js"></script>
    <script src="../js/toplist/createTable.js"></script>
    <script src="../js/toplist/mobileCheck.js"></script>
    <script>
      

      async function GetToplist(url) {
        const response = await fetch(url, {
          method: "GET",
          headers: { Accept: "application/json" },
        });
        if (response.ok) {
          const toplist = await response.json();
          return toplist;
        }
      }

      

      function insert(elem, value, position = "beforeend") {
        elem.innerHTML = "";
        elem.insertAdjacentHTML(position, value);
        return elem;
      }

      function checkValue(oldValue, newValue) {
        let delta = newValue - oldValue;
        let result;
        if (Math.abs(delta) < 0.01)
          //item.price === price
          result = 0;
        else if (delta < 0) {
          //item.price < price
          result = -1;
        } else if (delta > 0) {
          //item.price > price
          result = 1;
        }
        return result;
      }

      function createChangeElement(chg) {
        let span = document.createElement("span");
        span.classList.add("change");
        if (chg < 0) span.classList.add("lower-color");
        else if (chg > 0) span.classList.add("higher-color");
        span.insertAdjacentHTML("beforeend", `&percnt; ${chg.toFixed(2)}`);
        return span;
      }

      function createPriceElement(price) {
        let span = document.createElement("span");
        span.classList.add("price");

        span.insertAdjacentHTML("beforeend", `&dollar; ${toFixed(price)}`);
        return span;
      }

      function checkTable(collection) {
        let rows = document.querySelector("tbody").rows;
        let rowsLength = rows.length;
        let rowIndex = 0;
        collection.forEach((item) => {
          let id = rows[rowIndex].querySelector(".id").textContent;
          if (item.id != id) {
            rows[rowIndex].replaceWith(createTableRow(item));
            console.log(`Row ${id} recreated to ${item.id}`);
          } else {
            checkPriceCell(rows[rowIndex].querySelector(".price"), item.price);
            checkVolumeCell(rows[rowIndex].cells[2], item.direct);
            checkVolumeCell(rows[rowIndex].cells[3], item.total);
            checkVolumeCell(rows[rowIndex].cells[4], item.topTier);
            checkVolumeCell(rows[rowIndex].cells[5], item.marketCap);
            checkChangeCell(rows[rowIndex].querySelector(".change"), item.change);
          }

          rowIndex++;
        });
      }

      function checkChangeCell(cell, chg) {
        let oldPcnt = cell.textContent.match(/[+-]?\d+(\.\d+)?/g)[0];
        let newPcnt = chg.toFixed(2);
        let isEqual = checkValue(oldPcnt, newPcnt);
        if(isEqual != 0) {
          cell = insert(cell, `&percnt; ${newPcnt}`);
          cell.classList.remove("lower-color", "higher-color");
          if(newPcnt > 0) cell.classList.add("higher-color");
          else if(newPcnt < 0) cell.classList.add("lower-color");
        }
      }

      function checkVolumeCell(cell, volume) {
        let old = cell.textContent;
        let newValue = HighValueToVolume(volume);
        if (old != newValue) {
          if (volume < 0.00000001) cell = insert(cell, "-");
          else cell = insert(cell, newValue);
        }
      }

      function checkPriceCell(cell, price) {
        let oldPrice = cell.textContent.match(/[+-]?\d+(\.\d+)?/g)[0];
        let newPrice = toFixed(price);
        let isEqual = checkValue(oldPrice, newPrice);
        if (isEqual != 0) {
          if (isEqual < 0) {
            cell.classList.add("lower-color");
          } else if (isEqual > 0) {
            cell.classList.add("higher-color");
          }
          setTimeout(() => {
            cell.classList.remove("higher-color", "lower-color");
          }, 1500);
          cell = insert(cell, `&dollar; ${newPrice}`);
        }
      }

      async function start() {
        createTableHeader(
          "Coin",
          "Price",
          "Direct Vol",
          "Total Vol",
          "Top Tier Vol",
          "Market Cap",
          "&percnt;  Chg"
        );
        let toplist = await GetToplist(setGetUrl());
        createTableBody(toplist);

        // while(true)
        // {
        //   let result = await GetToplist(setGetUrl());
        //   checkTable(result);
        // }
        setInterval(async () => {
          let result = await GetToplist(setGetUrl());
          checkTable(result);
        }, 3500);
      }

      if(!getCookie("currency")) {
          getLocation().then((data) => {
            setCookie("currency", data.country.currency, {'max-age': 3600 * 24});
            postLocation(data);
          })
      }   
      start();
    </script>
  </body>
</html>
