<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Toplist</title>
    <link rel="stylesheet" href="../styles/toplist.css" />
    <link rel="stylesheet" href="../styles/coin.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Caprasimo&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Caprasimo&family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <h1>Toplist</h1>
    <div class="background"></div>
    <div class="toplist" id="table-container">
      <table>
      </table>
    </div>
    
    <script>
      function isMobile() {
        const regex =
          /Mobi|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i;
        return regex.test(navigator.userAgent);
      }
      function setGetUrl() {
        let url = "";
        if (isMobile()) url = "/crypt/mobile";
        else url = "/crypt";
        console.log(url);
        return url;
      }

      function createTableHeader(...params)
      {
        let thead = document.createElement("thead");
        let tr = document.createElement("tr");
        thead.append(tr);
        for(let p of params)
        {
          tr.insertAdjacentHTML("beforeend", `<th>${p}</th>`);
        }
        document.querySelector("table").append(thead);
      }

      function createTableBody(collection)
      {
        let tbody = document.createElement("tbody");
        
        collection.forEach(item => {
          tbody.append(createTableRow(item));
        });
        document.querySelector("table").append(tbody);
      }

      function createTableRow(coin)
      {
        let tr = document.createElement("tr");
        let tdCoin = document.createElement("td");
        tdCoin.classList.add("td-coin");
        tdCoin.append(createCoinElement(coin.id, coin.name, coin.iconUrl));
        tr.append(tdCoin);

        tdPrice = document.createElement("td");
        tdPrice.append(createPriceElement(coin.price));
        tr.append(tdPrice);

        let volumes = [coin.direct, coin.total, coin.topTier, coin.marketCap];
        for(let volume of volumes)
        {
          let tdVolume = document.createElement("td");
          tdVolume.append(createVolumeElement(`${volume}`, volume));
          tr.append(tdVolume);
        }

        let tdChange = document.createElement("td");
        tdChange.append(createChangeElement(coin.change));
        tr.append(tdChange);

        return tr;
      }


      function createChangeElement(chg)
      {
        let span = document.createElement("span");
        span.classList.add("change");
        span.insertAdjacentHTML("beforeend", `&percnt; ${chg.toFixed(2)}`);
        return span;
      }

      function createVolumeElement(name, value)
      {      
        let span = document.createElement("span");
        span.classList.add("volume");

        let result = "";
        if(value < 0.00000001)
          result = "-";
        else
          result = `&dollar; ${HighValueToString(value)}`;
        
        
        span.insertAdjacentHTML("beforeend", result);
        return span;
      }
      function HighValueToString(value)
      {
        const thousand = 1000;
        const million = thousand * 1000;
        const billion = million * 1000;
        let size = "";

        if(value > billion) {
          value /= billion;
          size = "B";
        }
        else if(value > million) {
          value /= million;
          size = "M";
        }
        else if(value > thousand) {
          value /= thousand;
          size = "K";
        }
        return `${value.toFixed(2)} ${size}`;
      }
      
      function createPriceElement(price)
      {
        let span = document.createElement("span");
        span.classList.add("price");
        let result = "&dollar; ";
        if(price < 0.000001) result += price.toFixed(8);
        else if(price < 0.0001) result += price.toFixed(6);
        else if(price - 1 < 0.0001) result += price.toFixed(4);
        else result += price.toFixed(2);

        span.insertAdjacentHTML("beforeend", result);
        return span;
      }
      function createCoinElement(id, name, logoUrl)
      {
        let div = document.createElement("div");
        div.classList.add("coin");

        let img = document.createElement("img");
        img.setAttribute("src", logoUrl);

        let right = document.createElement("div");
        right.classList.add("right");
        right.insertAdjacentHTML("beforeend", `<p>${name}</p><p class="id">${id}</p>`);

        div.prepend(img);
        div.append(right);
        return div;
      }

      async function GetToplist(url) {
        const response = await fetch(url, {
          method: "GET",
          headers: { Accept: "application/json" },
        });
        if(response.ok) {
          const toplist = await response.json();
          createTableBody(toplist.result);
        }
      }

      createTableHeader("Coin", "Price", "Direct Vol", "Total Vol", "Top Tier Vol", "Market Cap", "&percnt;  Chg");
      GetToplist(setGetUrl());
      // setTimeout(async function resetToplist() {
      //   await GetToplist(setGetUrl());
      //   clearOldTable();
      //   setTimeout(resetToplist, 5000);
      // }, 5000);
    </script>
  </body>
</html>
